{% extends "base.html" %}

{% block title %}
    Chatroom
{% endblock %}

{% block content %}
    <div class="pusher">
        <div class="chat-box">
            <div class="ui feed messages">
                {% for message in messages %}
                    {% include 'chat/_message.html' %}
                {% endfor %}
            </div>
        </div>

        <div class="input-area">
            <div class="ui form">
                <div class="field ten wide">
                    {% if current_user.is_authenticated %}
                        <img src="{{ active_user.avatar(64) }}">
                        <textarea id="message-textarea" name="body" rows="2" placeholder="Write your message here..."></textarea>
                    {% else %}
                        <div class="ui floating message">
                            <p>
                                Please <a href="{{ url_for('auth.login') }}">Sign In</a> or
                                <a href="{{ url_for('auth.register') }}">Sign Up</a> to send message.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}

    <script>
        $(document).ready(function() {
            var socket = io('/')

            var socketio_related = function() {
                socket.on('new message', function(msg) {
                    $('.messages').append(msg.data);
                    flask_moment_render_all()
                    scrollToBottom()
                    activateSemantics()
                });

                socket.on('online users', function(msg) {
                    $('#online-user').html(msg.data);
                });

                // 按回车发送消息
                $('#message-textarea').on('keydown', function(e) {
                    var message = $('#message-textarea').val().trim()
                    if (e.key == "Enter" && !e.shiftKey && message) {
                        e.preventDefault()
                        socket.emit('new message', {data: message})
                        $('#message-textarea').val('')
                    }
                })
            }

            var __main = function() {
                socketio_related()
            }

            __main()
        });
    </script>
{% endblock %}
